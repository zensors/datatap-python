steps:
  - label: ":copyright: Typechecking Module"
    commands:
      - "echo '--- Setting Up'"
      - "mkdir -p /build"
      - "cp -R . /build"
      - "cd /build"
      - "echo '--- Installing Packages'"
      - "pip install -r requirements_torch.txt"
      - "pip install -e '.[metrics,torch]'"
      - "yarn global add pyright"
      - "echo '+++ Running Pyright'"
      - "pyright"
    plugins:
      - docker#v3.7.0:
          image: "nikolaik/python-nodejs:python3.8-nodejs12"

  - label: ":python: Testing Module"
    commands:
      - "echo '--- Setting Up'"
      - "mkdir -p /test"
      - "cp -R . /test"
      - "cd /test"
      - "echo '--- Installing Packages'"
      - "pip install -e '.[metrics]'"
      - "echo '+++ Running Tests'"
      - "python -m unittest discover tests"
    plugins:
      - docker#v3.7.0:
          image: "python:3.8"

  - wait

  - label: ":package: Building and Pushing Wheel"
    commands:
      - "python3.7 setup.py bdist_wheel upload -r zensors"
    if: build.branch == "master"

  - label: ":github: Pushing to github"
    commands:
      - "git remote add origin git@github.com:Zensors/datatap-python.git || true"
      - "git push origin ${BUILDKITE_BRANCH}"
    if: "build.branch !~ /^refs/"
